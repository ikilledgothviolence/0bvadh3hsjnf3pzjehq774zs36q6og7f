<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Форум в стиле 2000-х — GitHub CSV</title>
<!-- Подключение шрифта и иконок -->
<link href="https://fonts.googleapis.com/css2?family=Arial&family=Material+Icons&display=swap" rel="stylesheet" />
<style>
  /* Минималистичный стиль 2000-х годов */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    background-color: black;
    color: #CCCCCC;
    font-family: Arial, sans-serif;
    font-size: 14px;
    line-height: 1.4;
  }

  /* Хедер - самый простой 2000-х */
  header {
    height: 64px;
    background: #111111;
    color: #CCCCCC;
    display: flex;
    align-items: center;
    padding-left: 16px;
    font-weight: bold;
    font-size: 20px;
    border-bottom: 2px solid #444;
  }

  main {
    padding: 20px 16px;
    max-width: 720px;
    margin: 0 auto;
  }

  /* Карточка сообщения */
  article.post {
    background-color: #222;
    border: 1px solid #666;
    padding: 12px 14px;
    margin-bottom: 12px;
  }

  .post-header {
    font-weight: bold;
    font-size: 13px;
    margin-bottom: 6px;
  }

  .post-date {
    font-weight: normal;
    font-size: 11px;
    color: #999999;
    float: right;
  }

  .post-body {
    white-space: pre-wrap;
    font-family: Arial, sans-serif;
  }

  /* Вложения */
  .post-media {
    margin-top: 10px;
    max-width: 100%;
  }
  .post-media img, .post-media video {
    max-width: 100%;
    max-height: 320px;
    border: 1px solid #444;
  }

  /* Убран подсветка */
  *::selection {
    background: transparent;
  }

  /* Форма */
  form#new-post-form {
    background-color: #111111;
    border: 1px solid #444;
    padding: 14px 16px;
    margin-top: 24px;
    margin-bottom: 40px;
  }

  form#new-post-form label {
    display: block;
    margin-bottom: 4px;
    color: #CCCCCC;
    font-weight: normal;
  }

  form#new-post-form input[type=text],
  form#new-post-form textarea,
  form#new-post-form input[type=file] {
    width: 100%;
    padding: 8px;
    font-size: 14px;
    margin-bottom: 10px;
    border: 1px solid #555;
    background: #000;
    color: #CCC;
    font-family: Arial, sans-serif;
  }

  form#new-post-form button {
    background-color: #333;
    color: #CCC;
    border: 1px solid #555;
    padding: 8px 18px;
    cursor: pointer;
    font-size: 14px;
    font-family: Arial, sans-serif;
  }

  form#new-post-form button:disabled {
    background-color: #111;
    cursor: not-allowed;
  }

  /* Тост уведомление */
  #toast {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: #ccc;
    padding: 8px 20px;
    border: 1px solid #444;
    font-size: 13px;
    display: none;
    opacity: 0.95;
    max-width: 300px;
    text-align: center;
  }

  /* Скроллбары простые */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #111;
  }
  ::-webkit-scrollbar-thumb {
    background: #444;
  }
</style>
</head>
<body>
<header>
  ФОРУМ В СТИЛЕ 2000-х
</header>
<main>
  <section aria-live="polite" aria-relevant="additions removals">
    <div id="posts-container" tabindex="0" aria-label="Сообщения форума">
      Загрузка сообщений...
    </div>

    <form id="new-post-form" aria-label="Добавить новый комментарий" novalidate>
      <label for="username-input">Никнейм:</label>
      <input id="username-input" name="username" type="text" maxlength="30" required placeholder="Ваш ник" autocomplete="off" />

      <label for="text-input">Сообщение:</label>
      <textarea id="text-input" name="text" maxlength="500" rows="4" required placeholder="Ваш комментарий"></textarea>

      <label for="file-input">Прикрепить файлы (фото, видео) (макс 3 файла)</label>
      <input id="file-input" type="file" name="files" multiple accept="image/*,video/*" />

      <button type="submit" disabled>Отправить</button>
    </form>
  </section>
</main>

<div id="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
  const CSV_URL = 'https://ikilledgothviolence.github.io/i16Chxh0GmmNjiRk1wdLnIrOMlN7MqyJ/comments.csv';

  const postsContainer = document.getElementById('posts-container');
  const form = document.getElementById('new-post-form');
  const usernameInput = document.getElementById('username-input');
  const textInput = document.getElementById('text-input');
  const fileInput = document.getElementById('file-input');
  const submitBtn = form.querySelector('button');
  const toast = document.getElementById('toast');

  // Функция для разбора CSV
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    return lines.slice(1).map(line => {
      // Разбираем CSV строку, учитывая кавычки и запятые
      const values = line.match(/(".*?"|[^",]+)(?=,|$)/g) || [];
      return headers.reduce((obj, header, idx) => {
        let val = values[idx] || "";
        if(val.startsWith('"') && val.endsWith('"')) {
          val = val.slice(1, -1).replace(/""/g, '"');
        }
        obj[header] = val;
        return obj;
      }, {});
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Функция отрисовки сообщений
  function renderPosts(posts) {
    postsContainer.innerHTML = '';
    if(posts.length === 0) {
      postsContainer.textContent = 'Пока нет сообщений.';
      return;
    }
    posts.forEach(post => {
      const article = document.createElement('article');
      article.className = 'post';
      const dateStr = new Date(post.date).toLocaleString('ru-RU', {dateStyle: 'short', timeStyle: 'short'}) || post.date;
      article.innerHTML = \`
        <div class="post-header">
          <span>\${escapeHtml(post.username)}</span>
          <span class="post-date">\${escapeHtml(dateStr)}</span>
        </div>
        <div class="post-body">\${escapeHtml(post.text)}</div>
      \`;
      if(post.fileUrl) {
        const mediaWrapper = document.createElement('div');
        mediaWrapper.className = 'post-media';
        if(post.fileType.startsWith('video')) {
          const video = document.createElement('video');
          video.src = post.fileUrl;
          video.controls = true;
          video.alt = 'Видео';
          mediaWrapper.appendChild(video);
        } else if(post.fileType.startsWith('image')) {
          const img = document.createElement('img');
          img.src = post.fileUrl;
          img.alt = 'Изображение';
          mediaWrapper.appendChild(img);
        }
        article.appendChild(mediaWrapper);
      }
      postsContainer.appendChild(article);
    });
  }

  async function loadPosts() {
    postsContainer.textContent = 'Загрузка сообщений...';
    try {
      const res = await fetch(CSV_URL);
      if(!res.ok) throw new Error('Ошибка загрузки CSV');
      const text = await res.text();
      let posts = parseCSV(text);
      posts.sort((a, b) => new Date(b.date) - new Date(a.date));
      renderPosts(posts);
    } catch(e) {
      postsContainer.textContent = 'Ошибка загрузки сообщений.';
      console.error(e);
    }
  }

  // Отображение тоста
  let toastTimeout;
  function showToast(message, duration=3000) {
    toast.textContent = message;
    toast.style.display = 'block';
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      toast.style.display = 'none';
    }, duration);
  }

  function validateForm() {
    submitBtn.disabled = !(usernameInput.value.trim().length > 0 && textInput.value.trim().length > 0);
  }

  usernameInput.addEventListener('input', validateForm);
  textInput.addEventListener('input', validateForm);

  form.addEventListener('submit', e => {
    e.preventDefault();
    showToast('Отправка сообщений на данный момент невозможна. Пожалуйста, редактируйте CSV вручную.', 5000);
  });

  // Загрузка сообщений при старте
  loadPosts();
</script>
</body>
</html>
