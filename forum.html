<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="gothviolence, ikilledgothviolence" />
    <meta name="robots" content="noindex, nofollow, noarchive" />
<title>www.ikilledgothviolence.ru</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #000 !important;
    color: #fff;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    height: 64px;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 24px;
    border-bottom: 2px solid #444;
    letter-spacing: 0.05em;
    user-select: none;
  }
  main {
    flex: 1 0 auto;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
    box-sizing: border-box;
  }
  form#postForm {
    background: #111;
    border: 2px solid #444;
    padding: 16px;
    border-radius: 4px;
    margin-bottom: 40px;
  }
  form#postForm label {
    display: block;
    margin-bottom: 6px;
    font-weight: bold;
    font-size: 13px;
  }
  form#postForm input[type="text"],
  form#postForm textarea {
    width: 100%;
    background: #000;
    border: 1px solid #666;
    color: #eee;
    font-size: 14px;
    padding: 8px;
    margin-bottom: 16px;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
  }
  form#postForm textarea {
    resize: vertical;
    min-height: 100px;
  }
  form#postForm input[type="file"] {
    margin-bottom: 16px;
    color: #ccc;
  }
  form#postForm button {
    background: #222;
    border: 2px solid #666;
    color: #fff;
    padding: 10px 20px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.3s, border-color 0.3s;
  }
  form#postForm button:hover, form#postForm button:focus {
    background: #444;
    border-color: #aaa;
    outline: none;
  }
  .error {
    color: #f55;
    font-size: 12px;
    margin-top: -12px;
    margin-bottom: 12px;
    user-select: none;
  }
  #postsContainer {
    background: #111;
    border: 2px solid #444;
    border-radius: 4px;
  }
  .post {
    border-bottom: 1px solid #333;
    padding: 16px;
  }
  .post:last-child {
    border-bottom: none;
  }
  .post-header {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 6px;
  }
  .post-content {
    white-space: pre-wrap;
    font-size: 14px;
    margin-bottom: 12px;
  }
  .post-media {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }
  .post-media > * {
    max-width: 120px;
    max-height: 90px;
    border: 1px solid #666;
    border-radius: 3px;
    object-fit: cover;
    cursor: pointer;
  }
  .post-media a {
    color: #ccc;
    text-decoration: underline;
    font-size: 12px;
    max-width: none;
    align-self: center;
  }
  @media (max-width: 640px) {
    main {
      padding: 12px;
    }
    .post-media > * {
      max-width: 80px;
      max-height: 60px;
    }
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
<header>www.ikilledgothviolence.ru</header>
<main>
  <form id="postForm" aria-label="Форма создания сообщения на форуме" novalidate>
    <label for="topicInput">Тема сообщения *</label>
    <input type="text" id="topicInput" name="topic" placeholder="Введите тему" required aria-required="true" aria-describedby="topicError" />
    <div class="error" id="topicError" aria-live="polite"></div>

    <label for="messageInput">Сообщение *</label>
    <textarea id="messageInput" name="message" placeholder="Введите текст сообщения" required aria-required="true" aria-describedby="messageError"></textarea>
    <div class="error" id="messageError" aria-live="polite"></div>

    <label for="filesInput">Загрузить видео, картинки, файлы</label>
    <input type="file" id="filesInput" name="files" multiple aria-describedby="filesHelp" />
    <small id="filesHelp" style="color:#999;user-select:none;">Поддерживаются изображения, видео и любые файлы.<br>Файлы автоматически загружаются на Firebase Storage.</small>

    <button type="submit" aria-label="Отправить сообщение">Отправить</button>
  </form>

  <section id="postsContainer" aria-live="polite" aria-relevant="additions" aria-label="Список сообщений форума">
    <!-- Сообщения будут добавляться сюда -->
  </section>
</main>

<script>
(() => {
  // Firebase конфигурация — замените на вашу (пример, нужно создать проект в Firebase)
  const firebaseConfig = {
    apiKey: "ВАШ_API_KEY",
    authDomain: "ВАШ_AUTH_DOMAIN",
    projectId: "ВАШ_PROJECT_ID",
    storageBucket: "ВАШ_STORAGE_BUCKET",
    messagingSenderId: "ВАШ_MESSAGING_SENDER_ID",
    appId: "ВАШ_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const form = document.getElementById('postForm');
  const topicInput = document.getElementById('topicInput');
  const messageInput = document.getElementById('messageInput');
  const filesInput = document.getElementById('filesInput');
  const postsContainer = document.getElementById('postsContainer');
  const topicError = document.getElementById('topicError');
  const messageError = document.getElementById('messageError');

  // Поддерживаемые типы превью
  const previewTypes = {
    image: ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'],
    video: ['video/mp4', 'video/webm', 'video/ogg']
  };

  // Валидация формы
  function validateForm() {
    let valid = true;
    topicError.textContent = '';
    messageError.textContent = '';

    if (!topicInput.value.trim()) {
      topicError.textContent = 'Требуется ввести тему сообщения';
      valid = false;
    }
    if (!messageInput.value.trim()) {
      messageError.textContent = 'Требуется ввести текст сообщения';
      valid = false;
    }
    return valid;
  }

  // Загрузка файлов на Firebase Storage и получение URL
  async function uploadFiles(files) {
    const uploadPromises = [];
    for (const file of files) {
      const storageRef = storage.ref('forum_files/' + Date.now() + '_' + file.name);
      const uploadTask = storageRef.put(file);
      uploadPromises.push(uploadTask.then(() => storageRef.getDownloadURL()).then(url => ({
        name: file.name,
        type: file.type,
        url
      })));
    }
    return Promise.all(uploadPromises);
  }

  // Создание DOM-элемента одного сообщения
  function createPostElement(post) {
    const postEl = document.createElement('article');
    postEl.className = 'post';
    postEl.setAttribute('tabindex', '0');

    const headerEl = document.createElement('div');
    headerEl.className = 'post-header';
    headerEl.textContent = post.topic;

    postEl.appendChild(headerEl);

    const contentEl = document.createElement('div');
    contentEl.className = 'post-content';
    contentEl.textContent = post.message;
    postEl.appendChild(contentEl);

    if (post.files && post.files.length > 0) {
      const mediaWrap = document.createElement('div');
      mediaWrap.className = 'post-media';
      post.files.forEach(file => {
        if (previewTypes.image.includes(file.type)) {
          const img = document.createElement('img');
          img.src = file.url;
          img.alt = `Изображение: ${file.name}`;
          img.tabIndex = 0;
          mediaWrap.appendChild(img);
        } else if (previewTypes.video.includes(file.type)) {
          const video = document.createElement('video');
          video.src = file.url;
          video.controls = true;
          video.title = `Видео: ${file.name}`;
          video.tabIndex = 0;
          video.style.maxHeight = '90px';
          mediaWrap.appendChild(video);
        } else {
          const link = document.createElement('a');
          link.href = file.url;
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.textContent = `Файл: ${file.name}`;
          link.tabIndex = 0;
          mediaWrap.appendChild(link);
        }
      });
      postEl.appendChild(mediaWrap);
    }

    return postEl;
  }

  // Отрисовка всех сообщений
  function renderPosts(posts) {
    postsContainer.innerHTML = '';
    if (!posts.length) {
      const emptyEl = document.createElement('p');
      emptyEl.style.color = '#777';
      emptyEl.style.textAlign = 'center';
      emptyEl.style.padding = '40px 0';
      emptyEl.textContent = 'Нет сообщений. Будьте первым!';
      postsContainer.appendChild(emptyEl);
      return;
    }
    posts.forEach(post => {
      postsContainer.appendChild(createPostElement(post));
    });
  }

  // Загрузка и слушатель изменений в Firestore - обновление в реальном времени
  function subscribePosts() {
    db.collection('forum_posts_2000').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
      const posts = [];
      snapshot.forEach(doc => {
        posts.push(doc.data());
      });
      renderPosts(posts);
    });
  }

  // Обработчик отправки формы
  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!validateForm()) return;

    let uploadedFiles = [];
    const files = filesInput.files;

    if (files.length > 0) {
      form.querySelector('button').disabled = true;
      try {
        uploadedFiles = await uploadFiles(files);
      } catch (error) {
        alert('Ошибка загрузки файлов: ' + error.message);
        form.querySelector('button').disabled = false;
        return;
      }
      form.querySelector('button').disabled = false;
    }

    // Создаем объект сообщения
    const newPost = {
      topic: topicInput.value.trim(),
      message: messageInput.value.trim(),
      files: uploadedFiles,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await db.collection('forum_posts_2000').add(newPost);
      form.reset();
      topicInput.focus();
    } catch (error) {
      alert('Ошибка отправки сообщения: ' + error.message);
    }
  });

  // Инициализация
  subscribePosts();
})();
</script>
</body>
</html>
